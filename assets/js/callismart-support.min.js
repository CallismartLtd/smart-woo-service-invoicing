class CallismartSupport{checkBoxSelection=new Set;constructor(e){this.pageBase=e instanceof HTMLElement?e:document.querySelector(e),this.serverConfig=smartwoo_admin_vars,this._cacheElements(),this._bindEvents()}_cacheElements(){this.inboxLeft=this.pageBase?.querySelector(".callismart-app-support-inbox_left"),this.inboxRight=this.pageBase?.querySelector(".callismart-app-support-inbox_right"),this.loader=this.pageBase?.querySelector("#loader"),this.messageBoxSvg=this.inboxRight?.querySelector("#noMessageSVG"),this.grantConsentBtn=document.querySelector("#callismart-consent-btn"),this.withdrawConsentBtn=document.querySelector("#callismart-withdraw-btn"),this.supportRadios=document.querySelectorAll('input[name="smartwoo_support_choice"]'),this.supportTitle=document.querySelector("#smartwoo-support-title"),this.supportShort=document.querySelector("#smartwoo-support-short"),this.supportPrice=document.querySelector("#smartwoo-support-price"),this.checkoutBtn=document.querySelector("#smartwoo-support-checkout-btn"),this.modal=document.querySelector(".smartwoo-modal-frame"),this.modalContent=this.modal?.querySelector(".smartwoo-modal-body"),this.closeModalBtn=this.modal?.querySelector(".smartwoo-modal-close-btn"),this.activeCheckoutURL=null,this.iframe=null,this.spinner=null}_bindEvents(){this.inboxLeft&&(this.inboxLeft.addEventListener("click",this._handleInboxLeftClicks.bind(this)),this.inboxLeft.addEventListener("submit",this._submitForm.bind(this)),this.inboxLeft.addEventListener("change",this._handleInboxLeftChange.bind(this))),this.inboxRight&&this.inboxRight.addEventListener("click",this._handleInboxRightClicks.bind(this)),this.grantConsentBtn?.addEventListener("click",this.consentManagement.bind(this)),this.withdrawConsentBtn?.addEventListener("click",this.consentManagement.bind(this)),this.supportRadios?.forEach((e=>e.addEventListener("change",this._handleProductSelection.bind(this)))),this.checkoutBtn?.addEventListener("click",this._handleCheckoutAction.bind(this)),this.closeModalBtn?.addEventListener("click",this._closeModal.bind(this)),this.modal?.addEventListener("click",(e=>e.target===this.modal&&this._closeModal())),window?.addEventListener("message",(e=>this._handleCheckoutMessage(e)),!1),document.querySelector("#smartwoo-copy-json")?.addEventListener("click",this._copyEnvToClipboard.bind(this))}_handleProductSelection(e){const t=e.target.closest(".smartwoo-support-item");if(!t)return;const s=this.safeJsonParse(t.getAttribute("data-product"));s&&(this.supportTitle.innerHTML=s.name||"",this.supportShort.innerHTML=s.short_description||"",this.supportPrice.innerHTML=s.price_html||"",this.checkoutBtn.dataset.url=s.checkout_url||"")}_handleCheckoutAction(){const e=this.checkoutBtn.dataset.url;e&&(this._openCheckoutModal(e),this.activeCheckoutURL=e)}_openCheckoutModal(e){let t;try{t=new URL(e),t.searchParams.set("LSCWP_CTRL","before_optm"),t.searchParams.set("utm","smartwoo_plugin")}catch(e){return void showNotification(e.message)}this.iframe&&this.iframe.remove();const s=document.createElement("iframe"),o=document.createElement("div");this.spinner=smartWooAddSpinner(o),this.modalContent.innerHTML="",jQuery(this.modal).fadeOut("fast",(()=>{s.src=t,s.width="100%",s.height="500",s.loading="eager",s.referrerPolicy="no-referrer-when-downgrade",s.allowFullscreen=!0,s.className="smartwoo-support-checkout",s.style.display="none",this.modalContent.appendChild(o),this.modalContent.appendChild(s),jQuery(this.modal).fadeIn("slow")})),s.onload=()=>{o.remove(),s.style.display="block",smartWooRemoveSpinner(this.spinner),s.contentWindow.postMessage({action:"callismart_support_init",appName:"Smart Woo"},t.origin)},this.iframe=s}_closeModal(){jQuery(this.modal).fadeOut("fast",(()=>{this.iframe?.remove(),this.modalContent.innerHTML="",this.iframe=null,smartWooRemoveSpinner(this.spinner)}))}_handleCheckoutMessage(e){if(!e.data||"callismart_checkout_complete"!==e.data.action)return;if(!this.activeCheckoutURL)return;const t=new URL(this.activeCheckoutURL).origin;if(e.origin!==t)return;const s=new FormData;s.set("action","smartwoo_verify_support_order"),s.set("security",smartwoo_admin_vars.security),s.set("order_id",e.data.order_id),s.set("order_key",e.data.order_key),s.set("token",e.data.token),fetch(smartwoo_admin_vars.ajax_url,{method:"POST",body:s,credentials:"same-origin"}).then((e=>e.json())).then((e=>{let t="Order was not successful";e.success&&e.data.is_valid&&(t="Order was successful"),showNotification(`${t}, please check your support inbox for more information.`,5e3)}))}async _fetch(e,t=!0){const s=new URL(this.serverConfig.ajax_url),o=new FormData;if(e instanceof FormData)for(const[t,s]of e.entries())o.append(t,s);else{if("object"!=typeof e||null===e)throw new Error("Invalid params type. Must be Object or FormData.");Object.entries(e).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>o.append(`${e}[]`,t))):null!=t&&o.append(e,t)}))}o.set("action","smartwoo_support_inbox_actions"),o.set("security",this.serverConfig.security),t&&this.showSpinner();try{const e=await fetch(s,{method:"POST",credentials:"same-origin",body:o}),t=e.headers.get("content-type")||"";let a;if(a=t.includes("application/json")?await e.json():await e.text(),!e.ok){const e=t.includes("application/json")?a?.data?.message||"Unexpected error":a;throw new Error(e)}return a}catch(e){e instanceof TypeError?showNotification("Please check your internet connection and try again later.",5e3):showNotification(e.message,5e3)}finally{this.hideSpinner()}}async _submitForm(e){e.preventDefault();const t=e.target.closest(".callismart-app-support-inbox_left-header-form"),s=t.querySelector("#bulk-action-select");if(!s.value.trim())return void showNotification("Please select a bulk action",5e3);if(!this.checkBoxSelection.size)return void showNotification("Please select at least one message!",5e3);const o=s.value,a="delete"===o;if(a&&!confirm("Are you sure you want to delete the selected message(s)?"))return;const i={action_type:o,message_ids:[...this.checkBoxSelection]};this.inboxLeft.querySelector(".masterCheckBox").classList.remove("active");const n=await this._fetch(i);if(s.value="",t.querySelector('button[type="submit"]').disabled=!0,this.checkBoxSelection.clear(),a){this._reRenderMessageList(n.data.messages);const e=this.inboxRight.querySelector("#mobile-close");return void(e&&e.click())}const r="unread"===o?"unread":"read",c="unread"===o?"read":"unread";i.message_ids.forEach((e=>{const t=this.inboxLeft.querySelector(`#message-id-${e}`);if(t){t.classList.remove(c),t.classList.add(r);const e=t.querySelector('input[type="checkbox"]');e&&(e.checked=!1)}})),showNotification(`Marked ${i.message_ids.length} message(s) as ${r}`,4e3)}_handleInboxLeftChange(e){const t=e.target.closest(".callismart-app-support-checkbox");if(t){const e=this.inboxLeft.querySelector(".masterCheckBox");let s=Array.from(this.inboxLeft.querySelectorAll(".callismart-app-support-checkbox")),o=s.every((e=>e.checked)),a=s.some((e=>e.checked));const i=t.id;return t.checked?this.checkBoxSelection.add(i):this.checkBoxSelection.delete(i),a?e.classList.add("active"):e.classList.remove("active"),e.querySelector("button.selectAll").disabled=o,void(e.querySelector("button.unSelectAll").disabled=!a)}const s=e.target.closest("#bulk-action-select"),o=e.target.closest(".callismart-app-support-inbox_left-header-form");s&&(o.querySelector('button[type="submit"]').disabled=""===s.value)}async _handleInboxLeftClicks(e){if(e.target.closest(".callismart-app-support-checkbox"))return;const t=e.target.closest(".masterCheckBox button.selectAll, .masterCheckBox button.unSelectAll");if(t)return this.inboxLeft.querySelectorAll(".callismart-app-support-checkbox").forEach((e=>{e.checked=t.classList.contains("selectAll"),e.dispatchEvent(new Event("change",{bubbles:!0}))})),void(t.disabled=!0);const s=e.target.closest(".callismart-app-support_message");if(s){const e=this.safeJsonParse(s.getAttribute("data-message-json"));if(!e)return;return void this._renderMessage(e,s)}const o=e.target.closest(".callismart-app-support-inbox-markAllRead, .callismart-app-support-inbox-refresh");let a=null;if(o&&(e.preventDefault(),a=this.safeJsonParse(o.getAttribute("data-args")),o.setAttribute("disabled",!0),o.classList.add("active")),a){const e=await this._fetch(a);if(!e)return;showNotification(e.data.message,1e4),o?.classList.remove("active"),o?.removeAttribute("disabled"),"all_read"===a.action_type?this.inboxLeft.querySelectorAll(".callismart-app-support_message:not(.empty-messages)").forEach((e=>e.classList.add("read")??e.classList.remove("unread"))):this._reRenderMessageList(e.data.messages)}}async _handleInboxRightClicks(e){if(e.target.closest("#mobile-close")){this.inboxRight.classList.remove("has-content");const e=this.inboxRight.querySelector(".callismart-app-support-inbox_right-header"),t=this.inboxRight.querySelector(".callismart-app-support-inbox_right-message-body"),s=this.inboxLeft.querySelector(".callismart-app-support_message.active");return e.innerHTML="",t.innerHTML="",t.appendChild(this.messageBoxSvg),void s?.classList.remove("active")}const t=e.target.closest(".button.unread-action, .button.delete-action");if(t){const e=this.safeJsonParse(t.getAttribute("data-args"));if(!e)return;let s="delete"===e.action_type,o="unread"===e.action_type;const a=this.inboxLeft.querySelector(`#message-id-${e.message_id}`);if(s&&!confirm("Are you sure you want to delete this message?"))return;if(o&&a.classList.contains("unread"))return;const i=await this._fetch(e);if(!i)return;if(s&&i.success){const e=this.inboxRight.querySelector("#mobile-close");e&&e.click(),a?.style.setProperty("opacity","0"),setTimeout((()=>a?.remove()),1100)}return void(o&&a.classList.add("unread"))}const s=e.target.closest("#callismart-support-verify-order");if(s){const t=s.getAttribute("href");if(t)return e.preventDefault(),this.showSpinner(),void fetch(t,{credentials:"include"}).then((e=>e.json())).then((e=>{const t=e?.data?.status?`Order status "${e.data.status}"`:`Error: "${e?.data?.message??"Unable to check order status"}"`;showNotification(t,5e3)})).catch((e=>{})).finally(this.hideSpinner.bind(this))}}_renderMessage(e,t){if(t.classList.contains("active"))return;const s=this.inboxRight.querySelector(".callismart-app-support-inbox_right-header"),o=this.inboxRight.querySelector(".callismart-app-support-inbox_right-message-body"),a=document.createElement("div"),i=document.createElement("h2"),n=document.createElement("p"),r=document.createElement("span");r.id="mobile-close",i.textContent=e.subject??"No subject",n.textContent=this._getRelativeTime(e.created_at),a.classList.add("subject"),a.appendChild(i),a.appendChild(n);const c=document.createElement("div"),l=document.createElement("button"),d=document.createElement("button");c.className="actions",l.className="button unread-action",l.type="button",l.textContent="Mark as unread",l.setAttribute("data-args",JSON.stringify({action_type:"unread",message_id:e.id})),d.textContent="Delete",d.className="button delete-action",d.type="button",d.setAttribute("data-args",JSON.stringify({action_type:"delete",message_id:e.id})),c.appendChild(l),c.appendChild(d),s.innerHTML="",s.appendChild(r),s.appendChild(a),s.appendChild(c),o.innerHTML=e.body,t&&t.classList.contains("unread")&&(this._fetch({action_type:"read",message_id:e.id},!1),t.classList.remove("unread")),this.inboxRight.classList.add("has-content"),this.inboxLeft.querySelectorAll(".callismart-app-support_message").forEach((e=>e.classList.remove("active"))),t.classList.add("active")}_reRenderMessageList(e){const t=this.inboxLeft.querySelector(".callismart-app-support-inbox_left-messages-list");if(this.inboxLeft.querySelector(".masterCheckBox").classList.remove("active"),!t)return;const s=t.querySelector(".empty-messages");t.style.opacity="0.4",t.querySelectorAll(".callismart-app-support_message:not(.empty-messages)").forEach((e=>e.remove()));const o=e&&Object.keys(e).length>0;s&&(s.style.display=o?"none":""),o&&Object.entries(e).forEach((([e,s])=>{const o=document.createElement("li");o.id=`message-id-${e}`,o.className="callismart-app-support_message "+(s.read?"read":"unread"),o.dataset.messageJson=JSON.stringify(s);const a=document.createElement("input");a.type="checkbox",a.id=e,a.className="callismart-app-support-checkbox";const i=document.createElement("div");i.className="callismart-app-support_message-info";const n=document.createElement("p");n.className="subject",n.textContent=s.subject||"No Subject";const r=document.createElement("span");r.className="message-time",n.appendChild(r);const c=document.createElement("span");c.className="exerpt",c.textContent=this.#e(s.body,6),i.appendChild(n),i.appendChild(c),o.appendChild(a),o.appendChild(i),t.appendChild(o)})),setTimeout((()=>{t.style.transition="opacity 0.25s ease-in",t.style.opacity="1"}),100)}async consentManagement(e){const t=e.target===this.grantConsentBtn,s=e.target===this.withdrawConsentBtn,o={action_type:"consent"};if(t?o.consent=!0:s&&(o.consent=!1),!t&&!s)return;const a=await this._fetch(o);showNotification(a.data.message,5e3),setTimeout((()=>window.location.reload()),5e3)}safeJsonParse(e){let t=null;try{t=JSON.parse(e)}catch(e){}return t}#e(e,t=6){const s=document.createElement("div");s.innerHTML=e||"";const o=(s.textContent||s.innerText||"").trim().split(/\s+/);return o.slice(0,t).join(" ")+(o.length>t?"…":"")}_getRelativeTime(e){if(!e)return"Unknown date";const t=new Date,s=new Date(e.replace(" ","T")),o=Math.floor((t.getTime()-s.getTime())/1e3);if(o<60)return"Just now";if(o<3600){const e=Math.floor(o/60);return`${e} ${1===e?"minute":"minutes"} ago`}if(o<86400){const e=Math.floor(o/3600);return`${e} ${1===e?"hour":"hours"} ago`}if(o<2592e3){const e=Math.floor(o/86400);return`${e} ${1===e?"day":"days"} ago`}return s.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}_copyEnvToClipboard(){const e=document.querySelector("#smartwoo-tools-json").value;navigator.clipboard.writeText(e).then((()=>showNotification("System JSON report copied!"))).catch((e=>showNotification(e.message)))}showSpinner(){this.spinner=smartWooAddSpinner(this.loader,!0)}hideSpinner(){this.loader&&(smartWooRemoveSpinner(this.spinner),this.loader.querySelectorAll("img").forEach((e=>e.remove())))}}document.addEventListener("DOMContentLoaded",(()=>new CallismartSupport(".callismart-app-support-inbox")));