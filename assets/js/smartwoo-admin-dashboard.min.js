class SmartWooAdminDashboard{static _events={};static _instance;constructor(){if(SmartWooAdminDashboard._instance)throw new Error("Use SmartWooAdminDashboard.getInstance()");SmartWooAdminDashboard._instance=this,this.serverConfig=smartwoo_admin_vars||{},this._hydrateDashboard(),this._bindEvents()}static getInstance(){return SmartWooAdminDashboard._instance||(SmartWooAdminDashboard._instance=new SmartWooAdminDashboard),SmartWooAdminDashboard._instance}_hydrateDashboard(){this.interactivitySection=document.querySelector(".sw-admin-dashboard-interactivity-section"),this.interactivitySection&&(this.sections={subscriptionList:this.interactivitySection.querySelector('[data-section="subscriptionList"]'),subscribersList:this.interactivitySection.querySelector('[data-section="subscribersList"]'),needsAttention:this.interactivitySection.querySelector('[data-section="needsAttention"]'),recentInvoices:this.interactivitySection.querySelector('[data-section="recentInvoices"]'),activities:this.interactivitySection.querySelector('[data-section="activities"]'),modal:this.interactivitySection.closest(".sw-admin-dashboard").querySelector('[data-section="modal"]'),search:this.interactivitySection.closest(".sw-admin-dashboard").querySelector(".smartwoo-interactivity-dashboard-search-container")},this.globalLoader=document.getElementById("swloader"))}_bindEvents(){this.interactivitySection&&(this.interactivitySection.addEventListener("click",(t=>{const e=t.target.closest("[data-section]");if(!e)return;switch(e.getAttribute("data-section")){case"subscriptionList":this._handleSubscriptionSectionEvent(t,e);break;case"subscribersList":this._handleSubscribersSectionEvent(t,e);break;case"needsAttention":this._handleNeedsAttentionSectionEvent(t,e);break;case"recentInvoices":this._handleRecentInvoicesSectionEvent(t,e);break;case"activities":this._handleActivitiesSectionEvent(t,e);break;default:break}})),this.sections.search.addEventListener("submit",this._performSearch.bind(this)),this.sections.search.addEventListener("input",this._resetFormInput.bind(this)),this.sections.modal.addEventListener("click",this._modalEventHandler.bind(this)),this.sections.modal.addEventListener("submit",this._modalEventHandler.bind(this)),this.sections.modal.addEventListener("input",this._modalEventHandler.bind(this)),this.sections.modal.addEventListener("change",this._modalEventHandler.bind(this)),this.sections.subscriptionList.addEventListener("change",this._tableCheckboxHandler.bind(this)),this.sections.subscriptionList.addEventListener("submit",this._submitBulkAction.bind(this)),this.sections.activities.addEventListener("submit",this._handleActivitiesSectionEvent.bind(this)),this.sections.activities.addEventListener("change",this._handleActivitiesSectionEvent.bind(this)),this.sections.activities.addEventListener("input",this._handleActivitiesSectionEvent.bind(this)),document.addEventListener("keydown",this._modalEventHandler.bind(this)),document.addEventListener("keydown",this._closeSearchSection.bind(this)),document.addEventListener("click",this._closeSearchSection.bind(this)),SmartWooAdminDashboard.on("markAsPaid","needsAttention",this._processInvoiceOptions),SmartWooAdminDashboard.on("sendPaymentReminder","needsAttention",this._processInvoiceOptions),SmartWooAdminDashboard.on("viewInvoiceDetails","needsAttention",this._showInvoiceDetails),SmartWooAdminDashboard.on("composeEmail","needsAttention",this._proComposeEmail),SmartWooAdminDashboard.on("autoProcessOrder","needsAttention",this._proAutoProcessOrder),SmartWooAdminDashboard.on("autoRenewService","needsAttention",this._proAutoRenewService),SmartWooAdminDashboard.on("viewOrderDetails","needsAttention",this._showOrderDetails),SmartWooAdminDashboard.on("viewRelatedInvoice","needsAttention",this._showInvoiceDetails),SmartWooAdminDashboard.on("previewServiceDetails","needsAttention",this._showServiceDetails))}async _handleSubscriptionSectionEvent(t,e){const s=t.target.closest(".smartwoo-dasboard-filter-button");let i=null;s&&(t.preventDefault(),i={filter:s.getAttribute("data-get-filter"),section:"subscriptionList",...this._parseJSONSafe(s.getAttribute("data-state-args"))});const o=t.target.closest(".sw-pagination-button");if(o){t.preventDefault();i={filter:e.getAttribute("data-current-filter"),section:"subscriptionList",...this._parseJSONSafe(o.getAttribute("data-pagination"))}}if(!i)return;const n=await this._fetch(i);if(!n)return;const a=(n?.table_rows??[]).join("");this._replaceSectionBodyHtml(e,a),this._updateSectionPagination(e,n.pagination),this._updateSectionHeading(e,n.title??"Subscriptions"),o||(this._resetDisabledButtons(e),t.target.closest(".smartwoo-dasboard-filter-button")?.setAttribute("disabled",!0)),e.setAttribute("data-current-filter",i.filter)}async _handleSubscribersSectionEvent(t,e){const s=t.target.closest(".sw-pagination-button");if(s){t.preventDefault();const i={filter:"subscribersList",section:"subscribersList",...this._parseJSONSafe(s.getAttribute("data-pagination"))},o=await this._fetch(i);if(!o)return;const n=(o?.table_rows??[]).join("");this._replaceSectionBodyHtml(e,n),this._updateSectionPagination(e,o.pagination)}}async _handleNeedsAttentionSectionEvent(t,e){const s=t.target.closest(".smartwoo-dasboard-filter-button");let i=null;s&&(t.preventDefault(),i={filter:s.getAttribute("data-get-filter"),section:"needsAttention",...this._parseJSONSafe(s.getAttribute("data-state-args"))});const o=t.target.closest(".sw-pagination-button");if(o){t.preventDefault();i={filter:e.getAttribute("data-current-filter"),section:"needsAttention",...this._parseJSONSafe(o.getAttribute("data-pagination"))}}if(i){const s=await this._fetch(i);if(!s)return;const n=(s?.table_rows??[]).join("");return this._replaceSectionBodyHtml(e,n),this._updateSectionPagination(e,s.pagination),this._updateSectionHeading(e,s.title??"Subscriptions"),o||(this._resetDisabledButtons(e),t.target.closest(".smartwoo-dasboard-filter-button")?.setAttribute("disabled",!0)),void e.setAttribute("data-current-filter",i.filter)}const n=t.target.closest(".smartwoo-options-dots")?.querySelector(".smartwoo-options-dots-items");e.querySelectorAll(".smartwoo-options-dots-items").forEach((t=>{t.classList.contains("active")&&t!==n&&t.classList.remove("active")})),n&&!t.target.closest(".smartwoo-options-dots-items")&&n.classList.toggle("active");const a=t.target.closest(".smartwoo-options-dots-items li");if(a){const t=a.getAttribute("data-action");let e=this._parseJSONSafe(a.getAttribute("data-args"));SmartWooAdminDashboard._events.needsAttention[t]&&SmartWooAdminDashboard._events.needsAttention[t].forEach((t=>t(e,a)))}}_handleRecentInvoicesSectionEvent(t,e){const s=t.target.closest(".sw-pagination-button");if(s)return t.preventDefault(),this._handlePaginationClick(e,s)}_handleActivitiesSectionEvent(t,e){if(!this.serverConfig.smartwoo_pro_is_installed)return;const s=SmartWooAdminDashboard._events.activities||{},i=t.type;e||(e=this.sections.activities),s[i]&&s[i].forEach((s=>s(t,e)))}_resetDisabledButtons(t){t?.querySelectorAll('.smartwoo-dasboard-filter-button[disabled="true"]').forEach((t=>t.disabled=!1))}async _fetch(t){const e=new URL(this.serverConfig.restApi.admin_url);e.pathname+="dashboard";const s={};t&&Object.keys(t).forEach((e=>{const i=t[e];s[e]="object"==typeof i?i:String(i)})),this._showLoader();try{const t=await fetch(e,{method:"POST",headers:{"X-WP-Nonce":this.serverConfig.restApi.WP_API_nonce,"Content-Type":`application/json; charset=${this.serverConfig.charset}`},credentials:"same-origin",body:JSON.stringify(s)}),i=await t.json();if(!t.ok){if(401===t.status||403===t.status){const t=new Error(i?.message??"Authentication failed. Please refresh current page.");throw t.type="AUTH_ERROR",t}const e=new Error(i?.message??`HTTP error: ${t.status}`);throw e.type="SMARTWOO_REST_ERROR",e}return i}catch(t){t instanceof TypeError?showNotification("Please check your internet connection and try again later.",5e3):("AUTH_ERROR"===t.type||"SMARTWOO_REST_ERROR"===t.type)&&showNotification(t.message,5e3)}finally{this._hideLoader()}}_replaceSectionBodyHtml(t,e){const s=t.querySelector(".smartwoo-table-content")||t.querySelector(".sw-dashboard-activities-section")||t;s&&jQuery(s).fadeOut("slow",(()=>{s.innerHTML=e,s.querySelector("tr td.sw-not-found")?s.closest("table")?.querySelector("thead")?.classList.add("smartwoo-hide"):s.closest("table")?.querySelector("thead")?.classList.remove("smartwoo-hide"),jQuery(s).fadeIn()}))}_updateSectionPagination(t,e){const s=t.querySelector(".sw-dashboard-pagination");if(!s)return;const i=s.querySelectorAll("button"),o=i[0],n=i[1];o.setAttribute("data-pagination",JSON.stringify({page:e.prev_page,limit:e.limit})),n.setAttribute("data-pagination",JSON.stringify({page:e.next_page,limit:e.limit})),e.next_page?n.removeAttribute("disabled"):n.setAttribute("disabled",!0),e.prev_page?o.removeAttribute("disabled"):o.setAttribute("disabled",!0),o.disabled&&n.disabled?s.classList.add("smartwoo-hide"):s.classList.remove("smartwoo-hide")}_updateSectionHeading(t,e){const s=t.querySelector(".sw-service-subscription-lists_current-heading");s&&(s.textContent=e)}_showLoader(){this.globalLoader&&(this.spinner=smartWooAddSpinner(this.globalLoader,!0))}_hideLoader(){this.globalLoader&&(smartWooRemoveSpinner(this.spinner),this.globalLoader.querySelectorAll("img").forEach((t=>t.remove())))}_parseJSONSafe(t){if(!t)return null;try{return JSON.parse(decodeURIComponent(t))}catch(t){return null}}static on(t,e,s){if("function"!=typeof s)return;this._events[e]||(this._events[e]={}),this._events[e][t]||(this._events[e][t]=[]);const i=s.bind(this._instance||SmartWooAdminDashboard.getInstance());this._events[e][t].push(i)}static trigger(t,e,s){this._events[e]&&this._events[e][t]&&this._events[e][t].forEach((t=>t(s)))}async _processInvoiceOptions(t,e){const s={section:"needsAttention_options",...t},i=await this._fetch(s);if(!i)return;showNotification(i.message??"Something went wrong",1e4);const o=e.closest("tr");o&&jQuery(o).fadeOut(2e3,(()=>{o.remove()}))}_proComposeEmail(){this.serverConfig.smartwoo_pro_is_installed||smartwoo_pro_ad("Compose Email","Craft and send personalized emails to your clients directly from your dashboard. Elevate your communication with the professional power of Smart Woo Pro.")}_proAutoProcessOrder(){this.serverConfig.smartwoo_pro_is_installed||smartwoo_pro_ad("Hands-Free Order Processing","Eliminate the endless cycle of manual reviews. Smart Woo Pro automatically processes subscription orders, sets up services, and notifies customers — saving you time and effort.")}_proAutoRenewService(){this.serverConfig.smartwoo_pro_is_installed||smartwoo_pro_ad("Auto Renew Service","Skip the manual work. With Smart Woo Pro, admins can instantly trigger a full subscription renewal — update invoices, mark services renewed, and send client emails — all in one click. Perfect for offline payments or fixing failed renewals.")}_showOrderDetails(t){const e=t.order_details;e?this._openModal(e.heading,e.body,e.footer):this._openModal("<p>No order details found.</p>")}_showInvoiceDetails(t){const e=t.invoice_details;e?this._openModal(e.heading,e.body,e.footer):this._openModal("<p>No invoice details found.</p>")}_showServiceDetails(t){const e=t.service_details;e?this._openModal(e.heading,e.body,e.footer):this._openModal("<p>No service details found.</p>")}async _openModal(t,e,s){try{jQuery(this.sections.modal).fadeOut("fast",(()=>{const i=this.sections.modal.querySelector(".smartwoo-modal-heading"),o=this.sections.modal.querySelector(".smartwoo-modal-body"),n=this.sections.modal.querySelector(".smartwoo-modal-footer");i.innerHTML=t||"<h2>Modal</h2>",o.innerHTML=e||"<p>No content</p>",n.innerHTML=s||"";const a=o.querySelector("object");a&&this._awaitInvoicePreview(a,o),jQuery(this.sections.modal).fadeIn("slow")}))}catch(t){return!1}finally{const t=new CustomEvent("SmartWooDashboardModalOpen",{detail:{modal:this.sections.modal}});document.dispatchEvent(t)}}_closeModal(){jQuery(this.sections.modal).fadeOut("slow",(()=>{const t=new CustomEvent("SmartWooDashboardModalClose",{detail:{modal:this.sections.modal}});t.modal=this.sections.modal,document.dispatchEvent(t)}))}_modalEventHandler(t){"Escape"===t.key||this.sections.modal===t.target||t.target.classList?.contains("smartwoo-modal-close-btn")?this._closeModal():SmartWooAdminDashboard.trigger(t.type,"modal",t)}_awaitInvoicePreview(t,e){t.style.opacity="0";const s=document.createElement("div");e.insertBefore(s,t);const i=smartWooAddSpinner(s);let o=!1;const n=()=>{o||(o=!0,smartWooRemoveSpinner(i),t.style.removeProperty("opacity"))};t.addEventListener("load",n,{once:!0}),t.addEventListener("error",n,{once:!0}),setTimeout((()=>{o||fetch(t.data,{method:"HEAD"}).then((t=>{if(!t.ok)throw new Error("Bad response")})).catch((()=>{const e=document.createElement("div");e.className="sw-error-notice",e.innerHTML='\n                            <div class="sw-notice"><p>Error!</p></div>\n                            <p>It appears your browser cannot display PDF files. \n                            Please use the buttons below to manage, print, or download the invoice.</p>\n                        ',smartWooRemoveSpinner(i),t.replaceWith(e),o=!0}))}),3e4)}_resetFormInput(t){const e=t.target.closest("input");e&&e.setCustomValidity("")}_tableCheckboxHandler(t){const e=t.target.closest(".serviceListMasterCheckbox");if(e){const t=this.sections.subscriptionList.querySelectorAll("tbody .serviceListCheckbox"),s=e.checked;return void t.forEach((t=>{t.checked=s}))}if(t.target.closest(".serviceListCheckbox")){const t=this.sections.subscriptionList.querySelectorAll("tbody .serviceListCheckbox"),e=Array.from(t).every((t=>t.checked)),s=this.sections.subscriptionList.querySelector(".serviceListMasterCheckbox");s&&(s.checked=e)}}async _submitBulkAction(t){t.preventDefault();const e=this.sections.subscriptionList.querySelectorAll("tbody .serviceListCheckbox"),s=Array.from(e).filter((t=>t.checked)).map((t=>t.getAttribute("data-value")));if(0===s.length)return void showNotification("Please select at least one subscription to perform bulk action.",5e3);const i=this.sections.subscriptionList.querySelector('form.sw-table-bulk-action-container select[name="selected_action"]'),o=i?.value;if(!o)return void showNotification("Please select a bulk action to perform.",5e3);if("delete"===o&&!confirm(`Are you sure you want to delete the selected subscription${s.length>1?"s":""}? This action cannot be undone.`))return;const n={filter:"bulkActions",section:"subscriptionList_bulk_action",action:o,service_ids:s},a=await this._fetch(n);if(!a)return;showNotification(a.message??"Bulk action completed.",1e4);const r=this.sections.subscriptionList.getAttribute("data-current-filter")||"allServices",c=this.sections.subscriptionList.querySelectorAll(".sw-dashboard-pagination button")[0],d=this._parseJSONSafe(c.getAttribute("data-pagination")),l={filter:r,section:"subscriptionList",page:d?.page?parseInt(d.page,10)+1:1,limit:d?.limit?parseInt(d.limit,10):10},h=await this._fetch(l);if(!h)return;const u=(h?.table_rows??[]).join("");this._replaceSectionBodyHtml(this.sections.subscriptionList,u),this._updateSectionPagination(this.sections.subscriptionList,h.pagination),this._updateSectionHeading(this.sections.subscriptionList,h.title??"Subscriptions"),this.sections.subscriptionList.setAttribute("data-current-filter",l.filter),i.value="";const m=this.sections.subscriptionList.querySelector(".serviceListMasterCheckbox");m&&(m.checked=!1)}async _performSearch(t){const e=t.target.closest("form.smartwoo-interactivity-dashboard-search-container");if(!e)return;t.preventDefault();const s=e.querySelector("input#smartwoo-search-input"),i=e.querySelector("select#search-select");if(s.value.trim().length||s.setCustomValidity("Please enter a search term"),i.value.trim().length||s.setCustomValidity("Please select a search type"),!e.reportValidity())return;const o={search_term:s.value.trim(),search_type:i.value.trim(),filter:"search",section:"search"},n=await this._fetch(o);if(!n)return;const a=e.querySelector("#smartwoo-search-result");a.innerHTML=this._cleanHTML(n.htmlContent),a.querySelector("tr td.sw-not-found")&&a.querySelector("table thead")?.classList.add("smartwoo-hide"),a.classList.add("has-content")}_closeSearchSection(t){const e=document.querySelector("#smartwoo-search-result");("Escape"===t.key&&e?.classList.contains("has-content")||t.target.closest(".close-search"))&&(t.preventDefault(),e.classList.remove("has-content"),setTimeout((()=>e.innerHTML=""),2e3))}_cleanHTML(t){const e=(new DOMParser).parseFromString(t,"text/html");return e.querySelectorAll("script").forEach((t=>t.remove())),e.querySelectorAll("*").forEach((t=>{[...t.attributes].forEach((e=>{/^on/i.test(e.name)&&t.removeAttribute(e.name)}))})),e.body.innerHTML}}addEventListener("DOMContentLoaded",(()=>{SmartWooAdminDashboard.getInstance()}));