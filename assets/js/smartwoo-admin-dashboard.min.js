class SmartWooAdminDashboard{static _events={};static _instance;constructor(){if(SmartWooAdminDashboard._instance)throw Error("Use SmartWooAdminDashboard.getInstance()");SmartWooAdminDashboard._instance=this,this.serverConfig=smartwoo_admin_vars||{},this._hydrateDashboard(),this._bindEvents()}static getInstance(){return SmartWooAdminDashboard._instance||(SmartWooAdminDashboard._instance=new SmartWooAdminDashboard),SmartWooAdminDashboard._instance}_hydrateDashboard(){this.interactivitySection=document.querySelector(".sw-admin-dashboard-interactivity-section"),this.interactivitySection&&(this.sections={subscriptionList:this.interactivitySection.querySelector('[data-section="subscriptionList"]'),subscribersList:this.interactivitySection.querySelector('[data-section="subscribersList"]'),needsAttention:this.interactivitySection.querySelector('[data-section="needsAttention"]'),recentInvoices:this.interactivitySection.querySelector('[data-section="recentInvoices"]'),activities:this.interactivitySection.querySelector('[data-section="activities"]'),modal:this.interactivitySection.closest(".sw-admin-dashboard").querySelector('[data-section="modal"]'),search:this.interactivitySection.closest(".sw-admin-dashboard").querySelector(".smartwoo-interactivity-dashboard-search-container")},this.globalLoader=document.getElementById("swloader"))}_bindEvents(){this.interactivitySection&&(this.interactivitySection.addEventListener("click",t=>{let e=t.target.closest("[data-section]");if(!e)return;let i=e.getAttribute("data-section");switch(i){case"subscriptionList":this._handleSubscriptionSectionEvent(t,e);break;case"subscribersList":this._handleSubscribersSectionEvent(t,e);break;case"needsAttention":this._handleNeedsAttentionSectionEvent(t,e);break;case"recentInvoices":this._handleRecentInvoicesSectionEvent(t,e);break;case"activities":this._handleActivitiesSectionEvent(t,e)}}),this.sections.search.addEventListener("submit",this._performSearch.bind(this)),this.sections.search.addEventListener("input",this._resetFormInput.bind(this)),this.sections.modal.addEventListener("click",this._modalEventHandler.bind(this)),this.sections.modal.addEventListener("submit",this._modalEventHandler.bind(this)),this.sections.modal.addEventListener("input",this._modalEventHandler.bind(this)),this.sections.modal.addEventListener("change",this._modalEventHandler.bind(this)),this.sections.subscriptionList.addEventListener("change",this._tableCheckboxHandler.bind(this)),this.sections.subscriptionList.addEventListener("submit",this._submitBulkAction.bind(this)),this.sections.activities.addEventListener("submit",this._handleActivitiesSectionEvent.bind(this)),this.sections.activities.addEventListener("change",this._handleActivitiesSectionEvent.bind(this)),this.sections.activities.addEventListener("input",this._handleActivitiesSectionEvent.bind(this)),document.addEventListener("keydown",this._modalEventHandler.bind(this)),document.addEventListener("keydown",this._closeSearchSection.bind(this)),document.addEventListener("click",this._closeSearchSection.bind(this)),SmartWooAdminDashboard.on("markAsPaid","needsAttention",this._processInvoiceOptions),SmartWooAdminDashboard.on("sendPaymentReminder","needsAttention",this._processInvoiceOptions),SmartWooAdminDashboard.on("viewInvoiceDetails","needsAttention",this._showInvoiceDetails),SmartWooAdminDashboard.on("composeEmail","needsAttention",this._proComposeEmail),SmartWooAdminDashboard.on("autoProcessOrder","needsAttention",this._proAutoProcessOrder),SmartWooAdminDashboard.on("autoRenewService","needsAttention",this._proAutoRenewService),SmartWooAdminDashboard.on("viewOrderDetails","needsAttention",this._showOrderDetails),SmartWooAdminDashboard.on("viewRelatedInvoice","needsAttention",this._showInvoiceDetails),SmartWooAdminDashboard.on("previewServiceDetails","needsAttention",this._showServiceDetails))}async _handleSubscriptionSectionEvent(t,e){let i=t.target.closest(".smartwoo-dasboard-filter-button"),s=null;i&&(t.preventDefault(),s={filter:i.getAttribute("data-get-filter"),section:"subscriptionList",...this._parseJSONSafe(i.getAttribute("data-state-args"))});let o=t.target.closest(".sw-pagination-button");if(o){t.preventDefault();let a=e.getAttribute("data-current-filter");s={filter:a,section:"subscriptionList",...this._parseJSONSafe(o.getAttribute("data-pagination"))}}if(!s)return;let n=await this._fetch(s);if(!n)return;let r=n?.table_rows??[],c=r.join("");this._replaceSectionBodyHtml(e,c),this._updateSectionPagination(e,n.pagination),this._updateSectionHeading(e,n.title??"Subscriptions"),o||(this._resetDisabledButtons(e),t.target.closest(".smartwoo-dasboard-filter-button")?.setAttribute("disabled",!0)),e.setAttribute("data-current-filter",s.filter)}async _handleSubscribersSectionEvent(t,e){let i=t.target.closest(".sw-pagination-button");if(i){t.preventDefault();let s={filter:"subscribersList",section:"subscribersList",...this._parseJSONSafe(i.getAttribute("data-pagination"))},o=await this._fetch(s);if(!o)return;let a=o?.table_rows??[],n=a.join("");this._replaceSectionBodyHtml(e,n),this._updateSectionPagination(e,o.pagination)}}async _handleNeedsAttentionSectionEvent(t,e){let i=t.target.closest(".smartwoo-dasboard-filter-button"),s=null;i&&(t.preventDefault(),s={filter:i.getAttribute("data-get-filter"),section:"needsAttention",...this._parseJSONSafe(i.getAttribute("data-state-args"))});let o=t.target.closest(".sw-pagination-button");if(o){t.preventDefault();let a=e.getAttribute("data-current-filter");s={filter:a,section:"needsAttention",...this._parseJSONSafe(o.getAttribute("data-pagination"))}}if(s){let n=await this._fetch(s);if(!n)return;let r=n?.table_rows??[],c=r.join("");this._replaceSectionBodyHtml(e,c),this._updateSectionPagination(e,n.pagination),this._updateSectionHeading(e,n.title??"Subscriptions"),o||(this._resetDisabledButtons(e),t.target.closest(".smartwoo-dasboard-filter-button")?.setAttribute("disabled",!0)),e.setAttribute("data-current-filter",s.filter);return}let l=t.target.closest(".smartwoo-options-dots"),d=l?.querySelector(".smartwoo-options-dots-items");e.querySelectorAll(".smartwoo-options-dots-items").forEach(t=>{t.classList.contains("active")&&t!==d&&t.classList.remove("active")}),d&&!t.target.closest(".smartwoo-options-dots-items")&&d.classList.toggle("active");let h=t.target.closest(".smartwoo-options-dots-items li");if(h){let u=h.getAttribute("data-action"),m=this._parseJSONSafe(h.getAttribute("data-args"));SmartWooAdminDashboard._events.needsAttention[u]&&SmartWooAdminDashboard._events.needsAttention[u].forEach(t=>t(m,h))}}_handleRecentInvoicesSectionEvent(t,e){let i=t.target.closest(".sw-pagination-button");if(i)return t.preventDefault(),this._handlePaginationClick(e,i)}_handleActivitiesSectionEvent(t,e){if(!this.serverConfig.smartwoo_pro_is_installed)return;let i=SmartWooAdminDashboard._events.activities||{},s=t.type;e||(e=this.sections.activities),i[s]&&i[s].forEach(i=>i(t,e))}_resetDisabledButtons(t){t?.querySelectorAll('.smartwoo-dasboard-filter-button[disabled="true"]').forEach(t=>t.disabled=!1)}async _fetch(t){let e=new URL(this.serverConfig.restApi.admin_url);e.pathname+="dashboard";let i={};t&&Object.keys(t).forEach(e=>{let s=t[e];i[e]="object"==typeof s?s:String(s)}),this._showLoader();try{let s=await fetch(e,{method:"POST",headers:{"X-WP-Nonce":this.serverConfig.restApi.WP_API_nonce,"Content-Type":`application/json; charset=${this.serverConfig.charset}`},credentials:"same-origin",body:JSON.stringify(i)}),o=await s.json();if(!s.ok){if(401===s.status||403===s.status){let a=Error(o?.message??"Authentication failed. Please refresh current page.");throw a.type="AUTH_ERROR",a}let n=Error(o?.message??`HTTP error: ${s.status}`);throw n.type="SMARTWOO_REST_ERROR",n}return o}catch(r){r instanceof TypeError?showNotification("Please check your internet connection and try again later.",5e3):"AUTH_ERROR"===r.type?showNotification(r.message,5e3):"SMARTWOO_REST_ERROR"===r.type?showNotification(r.message,5e3):console.error("Unexpected error:",r)}finally{this._hideLoader()}}_replaceSectionBodyHtml(t,e){let i=t.querySelector(".smartwoo-table-content")||t.querySelector(".sw-dashboard-activities-section")||t;i&&jQuery(i).fadeOut("slow",()=>{i.innerHTML=e,i.querySelector("tr td.sw-not-found")?i.closest("table")?.querySelector("thead")?.classList.add("smartwoo-hide"):i.closest("table")?.querySelector("thead")?.classList.remove("smartwoo-hide"),jQuery(i).fadeIn()})}_updateSectionPagination(t,e){let i=t.querySelector(".sw-dashboard-pagination");if(!i)return;let s=i.querySelectorAll("button"),o=s[0],a=s[1];o.setAttribute("data-pagination",JSON.stringify({page:e.prev_page,limit:e.limit})),a.setAttribute("data-pagination",JSON.stringify({page:e.next_page,limit:e.limit})),e.next_page?a.removeAttribute("disabled"):a.setAttribute("disabled",!0),e.prev_page?o.removeAttribute("disabled"):o.setAttribute("disabled",!0),o.disabled&&a.disabled?i.classList.add("smartwoo-hide"):i.classList.remove("smartwoo-hide")}_updateSectionHeading(t,e){let i=t.querySelector(".sw-service-subscription-lists_current-heading");i&&(i.textContent=e)}_showLoader(){this.globalLoader&&(this.spinner=smartWooAddSpinner(this.globalLoader,!0))}_hideLoader(){this.globalLoader&&(smartWooRemoveSpinner(this.spinner),this.globalLoader.querySelectorAll("img").forEach(t=>t.remove()))}_parseJSONSafe(t){if(!t)return null;try{return JSON.parse(decodeURIComponent(t))}catch(e){return null}}static on(t,e,i){if("function"!=typeof i){console.warn("Even handler must be a valid callback function.");return}this._events[e]||(this._events[e]={}),this._events[e][t]||(this._events[e][t]=[]);let s=i.bind(this._instance||SmartWooAdminDashboard.getInstance());this._events[e][t].push(s)}static trigger(t,e,i){this._events[e]&&this._events[e][t]&&this._events[e][t].forEach(t=>t(i))}async _processInvoiceOptions(t,e){let i={section:"needsAttention_options",...t},s=await this._fetch(i);if(!s)return;showNotification(s.message??"Something went wrong",1e4);let o=e.closest("tr");o&&jQuery(o).fadeOut(2e3,()=>{o.remove()})}_proComposeEmail(){this.serverConfig.smartwoo_pro_is_installed||smartwoo_pro_ad("Compose Email","Craft and send personalized emails to your clients directly from your dashboard. Elevate your communication with the professional power of Smart Woo Pro.")}_proAutoProcessOrder(){this.serverConfig.smartwoo_pro_is_installed||smartwoo_pro_ad("Hands-Free Order Processing","Eliminate the endless cycle of manual reviews. Smart Woo Pro automatically processes subscription orders, sets up services, and notifies customers — saving you time and effort.")}_proAutoRenewService(){this.serverConfig.smartwoo_pro_is_installed||smartwoo_pro_ad("Auto Renew Service","Skip the manual work. With Smart Woo Pro, admins can instantly trigger a full subscription renewal — update invoices, mark services renewed, and send client emails — all in one click. Perfect for offline payments or fixing failed renewals.")}_showOrderDetails(t){let e=t.order_details;if(!e){this._openModal("<p>No order details found.</p>");return}this._openModal(e.heading,e.body,e.footer)}_showInvoiceDetails(t){let e=t.invoice_details;if(!e){this._openModal("<p>No invoice details found.</p>");return}this._openModal(e.heading,e.body,e.footer)}_showServiceDetails(t){let e=t.service_details;if(!e){this._openModal("<p>No service details found.</p>");return}this._openModal(e.heading,e.body,e.footer)}async _openModal(t,e,i){try{jQuery(this.sections.modal).fadeOut("fast",()=>{let s=this.sections.modal.querySelector(".smartwoo-modal-heading"),o=this.sections.modal.querySelector(".smartwoo-modal-body"),a=this.sections.modal.querySelector(".smartwoo-modal-footer");s.innerHTML=t||"<h2>Modal</h2>",o.innerHTML=e||"<p>No content</p>",a.innerHTML=i||"";let n=o.querySelector("object");n&&this._awaitInvoicePreview(n,o),jQuery(this.sections.modal).fadeIn("slow")})}catch(s){return!1}finally{let o=new CustomEvent("SmartWooDashboardModalOpen",{detail:{modal:this.sections.modal}});document.dispatchEvent(o)}}_closeModal(){jQuery(this.sections.modal).fadeOut("slow",()=>{let t=new CustomEvent("SmartWooDashboardModalClose",{detail:{modal:this.sections.modal}});t.modal=this.sections.modal,document.dispatchEvent(t)})}_modalEventHandler(t){if("Escape"===t.key||this.sections.modal===t.target||t.target.classList?.contains("smartwoo-modal-close-btn")){this._closeModal();return}SmartWooAdminDashboard.trigger(t.type,"modal",t)}_awaitInvoicePreview(t,e){t.style.opacity="0";let i=document.createElement("div");e.insertBefore(i,t);let s=smartWooAddSpinner(i),o=!1,a=()=>{o||(o=!0,smartWooRemoveSpinner(s),t.style.removeProperty("opacity"))};t.addEventListener("load",a,{once:!0}),t.addEventListener("error",a,{once:!0}),setTimeout(()=>{o||fetch(t.data,{method:"HEAD"}).then(t=>{if(!t.ok)throw Error("Bad response")}).catch(()=>{let e=document.createElement("div");e.className="sw-error-notice",e.innerHTML=`
                            <div class="sw-notice"><p>Error!</p></div>
                            <p>It appears your browser cannot display PDF files. 
                            Please use the buttons below to manage, print, or download the invoice.</p>
                        `,smartWooRemoveSpinner(s),t.replaceWith(e),o=!0})},3e4)}_resetFormInput(t){let e=t.target.closest("input");e&&e.setCustomValidity("")}_tableCheckboxHandler(t){let e=t.target.closest(".serviceListMasterCheckbox");if(e){let i=this.sections.subscriptionList.querySelectorAll("tbody .serviceListCheckbox"),s=e.checked;i.forEach(t=>{t.checked=s});return}let o=t.target.closest(".serviceListCheckbox");if(o){let a=this.sections.subscriptionList.querySelectorAll("tbody .serviceListCheckbox"),n=Array.from(a).every(t=>t.checked),r=this.sections.subscriptionList.querySelector(".serviceListMasterCheckbox");r&&(r.checked=n)}}async _submitBulkAction(t){t.preventDefault();let e=this.sections.subscriptionList.querySelectorAll("tbody .serviceListCheckbox"),i=Array.from(e).filter(t=>t.checked).map(t=>t.getAttribute("data-value"));if(0===i.length){showNotification("Please select at least one subscription to perform bulk action.",5e3);return}let s=this.sections.subscriptionList.querySelector('form.sw-table-bulk-action-container select[name="selected_action"]'),o=s?.value;if(!o){showNotification("Please select a bulk action to perform.",5e3);return}if("delete"===o&&!confirm(`Are you sure you want to delete the selected subscription${i.length>1?"s":""}? This action cannot be undone.`))return;let a=await this._fetch({filter:"bulkActions",section:"subscriptionList_bulk_action",action:o,service_ids:i});if(!a)return;showNotification(a.message??"Bulk action completed.",1e4);let n=this.sections.subscriptionList.getAttribute("data-current-filter")||"allServices",r=this.sections.subscriptionList.querySelectorAll(".sw-dashboard-pagination button"),c=r[0],l=this._parseJSONSafe(c.getAttribute("data-pagination")),d=l?.page?parseInt(l.page,10)+1:1,h=l?.limit?parseInt(l.limit,10):10,u={filter:n,section:"subscriptionList",page:d,limit:h},m=await this._fetch(u);if(!m)return;let b=m?.table_rows??[],p=b.join("");this._replaceSectionBodyHtml(this.sections.subscriptionList,p),this._updateSectionPagination(this.sections.subscriptionList,m.pagination),this._updateSectionHeading(this.sections.subscriptionList,m.title??"Subscriptions"),this.sections.subscriptionList.setAttribute("data-current-filter",u.filter),s.value="";let v=this.sections.subscriptionList.querySelector(".serviceListMasterCheckbox");v&&(v.checked=!1)}async _performSearch(t){let e=t.target.closest("form.smartwoo-interactivity-dashboard-search-container");if(!e)return;t.preventDefault();let i=e.querySelector("input#smartwoo-search-input"),s=e.querySelector("select#search-select");if(i.value.trim().length||i.setCustomValidity("Please enter a search term"),s.value.trim().length||i.setCustomValidity("Please select a search type"),!e.reportValidity())return;let o={search_term:i.value.trim(),search_type:s.value.trim(),filter:"search",section:"search"},a=await this._fetch(o);if(!a)return;let n=e.querySelector("#smartwoo-search-result");n.innerHTML=this._cleanHTML(a.htmlContent),n.querySelector("tr td.sw-not-found")&&n.querySelector("table thead")?.classList.add("smartwoo-hide"),n.classList.add("has-content")}_closeSearchSection(t){let e=document.querySelector("#smartwoo-search-result");("Escape"===t.key&&e?.classList.contains("has-content")||t.target.closest(".close-search"))&&(t.preventDefault(),e.classList.remove("has-content"),setTimeout(()=>e.innerHTML="",2e3))}_cleanHTML(t){let e=new DOMParser,i=e.parseFromString(t,"text/html");return i.querySelectorAll("script").forEach(t=>t.remove()),i.querySelectorAll("*").forEach(t=>{[...t.attributes].forEach(e=>{/^on/i.test(e.name)&&t.removeAttribute(e.name)})}),i.body.innerHTML}}addEventListener("DOMContentLoaded",()=>{SmartWooAdminDashboard.getInstance()});